<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atlassian Authentication</title>
  </head>
  <body>
    <script>
      const clientId = "88fe838c-f782-4d20-98f6-fb88f3889146";
      const atlClientId = "HVy47ZY8PgWcRQRLs5VC8RwdqvuFRRbW";
      const atlClientSecret =
        "ATOANSa7-e1CoVp38sYHhrjVFaW_uUXVXhgmX8lkRIA1vz9LZ_3v1Cz13JaNJN98wF6501C9FC0C";
      const parameters = new URLSearchParams(window.location.href);
      if (parameters.has("code") == false) {
        window.close();
      } else {
        const code = parameters.get("code");
        console.log(code);
        const run = async () => {
          async function getAccessToken() {
            await fetch("https://auth.atlassian.com/oauth/token", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                grant_type: "authorization_code",
                client_id: atlClientId,
                client_secret: atlClientSecret,
                code: code,
                redirect_uri: "https://localhost:53000/atlassianAuth.html",
              }),
            })
              .then((response) => response.json())
              .then((response) => {
                localStorage.setItem(
                  `${clientId}:refresh_token`,
                  response.refresh_token
                );
              })
              .catch((error) =>
                console.log(
                  "Authentication failed window closed or consent denied: ",
                  error
                )
              );
            const parentWindow = window.opener;
            parentWindow.location.reload();
            window.close();
          }
          await getAccessToken();
        };
        run();
      }
    </script>
  </body>
</html>
